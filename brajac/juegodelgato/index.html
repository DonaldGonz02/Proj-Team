<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parte del proyecto, Bradley</title>
    <style>
        body{
            width: 960px;
            margin: 0 auto;
        }
        h1{
            text-align: center;
            color: rgb(8, 11, 179);
        }
        #pantalla{
            border: groove 10px rgb(17, 21, 77);
            background: rgb(119, 207, 236);
        }
        #boton{
            background-color: rgb(169, 187, 4);
            color: white;
            font-size: 20px;
            text-align: center;
            font-weight: bolder;
            padding: 3px;
            border: solid 2px black;
        }
        #boton:hover{
            background-color: rgb(237, 248, 134);
            font-size: 22px;
        }
    </style>
    <script>
        //Variables necesarias
        var ctx, canvas;
        var fichas_array = new Array();
        var COLUMNAS = 3;
        var RENGLONES = 3;
        var fichas_X = 0;
        var fichas_O = 0;
        var tiradas = 0;
        var gameOver = false;
        var lados = 120;

        //Función al cargar la página Web
        window.onload = function(){
            //Verifición del canvas y ejecución, si funciona bien o sino mensaje de error
            canvas = document.getElementById("pantalla");
            if (canvas && canvas.getContext){
                ctx = canvas.getContext("2d");
                if (ctx){
                    //Si canvas se ejecuto bien
                    gato();
                    mensaje("Piensa tu jugada.");
                    canvas.addEventListener("click",seleccionUsuario,false);
                } else{
                    //Si hay error
                    alert("Error al crear el contexto!");
                }
            }
        }

        //Función de la visualización del tablero de juego
        function gato(){
            //Estas funciones hacen que se cargue la imagen del tablero en el canvas
            var imagen = new Image();
            function procesaImagen(){
                ctx.drawImage(imagen,0,0);
            }
            imagen.src = "tablero.png";
            imagen.onload = function(e){
                procesaImagen();
            }
            //Se insertan las fichas en array y se dibujan, posiciones Ficha, Renglon, Columna.
            fichas_array.push(new Ficha(288,29,lados,lados,0,0,0));
            fichas_array.push(new Ficha(423,29,lados,lados,1,0,1));
            fichas_array.push(new Ficha(556,29,lados,lados,2,0,2));
            fichas_array.push(new Ficha(288,160,lados,lados,3,1,0));
            fichas_array.push(new Ficha(420,160,lados,lados,4,1,1));
            fichas_array.push(new Ficha(560,160,lados,lados,5,1,2));
            fichas_array.push(new Ficha(286,295,lados,lados,6,2,0));
            fichas_array.push(new Ficha(424,295,lados,lados,7,2,1));
            fichas_array.push(new Ficha(560,295,lados,lados,8,2,2));
        }

        //Función de interacción con el usuario, mensajes de victoria o derrota, empate y turno.
        function mensaje(cadena){
            var lon = (canvas.width-(20*cadena.length))/2;
            ctx.strokeStyle = "blue";
            ctx.clearRect(0,420,canvas.width,100);
            ctx.font = "bold 40px Courier";
            ctx.fillText(cadena,lon,470);
        }
        
        //Función de creación de fichas como objeto, colocando sus valores correspondientes.
        function Ficha(x,y,w,h,i,ren,col){
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.i = i;
            this.ren = ren;
            this.col = col;
            this.peso = 0;
            this.valor = "";
            this.pinta = pintaFicha;
        }

        //Función de mostrar el valor de la ficha en la pantalla, ya sea x - o.
        function pintaFicha(valor){
            this.valor = valor;
            ctx.font = "bold 100px Arial";
            ctx.fillStyle = "blue";
            ctx.fillText(valor, this.x+30, this.y+100, this.w, this.h);
                
        }

        //Función de ajustar el valor cuando el usuario de click en alguna posición.
        function ajustar(xx, yy){
            var posCanvas = canvas.getBoundingClientRect();
            var x = xx - posCanvas.left;
            var y = yy - posCanvas.top;
            return {x:x, y:y}
        }

        //Función de lo que pasará en la jugada del usuario (Selección del mouse).
        function seleccionUsuario(e){
            //Ajusta la posicion en coordenadas del click, llama la función ajustar.
            var pos = ajustar(e.clientX, e.clientY);
            var x = pos.x;
            var y = pos.y;
            //Ciclo de verificacion si se ha dado en el lugar correcto y si el lugar está vacio.        
            var ficha;
            for (i=0; i<fichas_array.length; i++){
                ficha = fichas_array[i];
                //Aqui se verifica si el click esta dentro del espacio correcto.
                if (ficha.x > 0){
                if ((x > ficha.x)&&
                    (x < ficha.x + ficha.w)&&
                    (y > ficha.y)&&
                    (y < ficha.y + ficha.h)){
                    tiradas++;  //aumenta uno a las tiradas
                        break;  //Saca del ciclo
                    }
                }
            }
            //comprobar si el espacio es aceptable para colocar la ficha.
            if(i<fichas_array.length){
                //Se muestra en la pantalla la jugada del usuario (si esta vacio el lugar).
                if (ficha.valor == ""){
                    ficha.pinta("X");
                    //Se lanza un timer(temporizador) para que la pc haga su jugada, en un segundo de retraso.
                    setTimeout(tiraMaquina,1000);
                }
            }
            //Verifición si ganamos.
                verificaRenglones(true);
                verificaColumnas(true);
                verificaDiagonal1(true);
                verificaDiagonal2(true);
            if(gameOver==false && tiradas<9){ //jugadas, si se llenan todas se llama al listener (Empate).
                //Si no ganamos.
                mensaje("Esperando respuesta...");
                canvas.removeEventListener("click",seleccionUsuario,false);
            } else {
                //Si ganamos, desactivamos el listener de empate.
                if(gameOver==false){
                mensaje("Oh, quedaron empatados.");
                }
            }
        }

        //Verifica al ganador, el usuario o la computadora.
        function verificaFin(O, X){
            fin = false;
            if (X == 3) {
                fin = true;
                mensaje("¡Felicitaciones, has vencido a la máquina!"); //Victoria del usuario.
                canvas.removeEventListener("click",seleccionUsuario,false);
            } else if (O == 3) {
                fin = true;
                mensaje("Lo lamento, te han ganado."); //Victoria de la computadora.
                canvas.removeEventListener("click",seleccionUsuario,false);
            }
            return fin;
        }

        //Función bucar la ficha con la que se está jugando, te regresa tu ficha en tu turno.
        function buscaFicha(i,j){
            for(k=0; k<fichas_array.length; k++){
                ficha = fichas_array[k];
                if(ficha.ren == i && ficha.col==j){
                    break;
                }
            }
            return ficha;
        }

        

    </script>
</head>
<body>
    <h1>Bienvenidos, éste es el "juego del gato"</h1>
        <canvas id="pantalla" width="960px" height="500px">
            Lo sentimos, tú navegador no soporta Canvas.
        </canvas>
        <button id="boton" type="reset" onclick="javascript:window.location.reload();">¡Vuelve a jugar!</button>
        <br><br><br><br>
        <center><a href="file:///C:/laragon/www/Proj-Team/dongon/indexHP.html"><img src="file:///C:/laragon/www/Proj-Team/brajac/juegodelgato/inicio.jpg"></a></center>
</body>
</html>